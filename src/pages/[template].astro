---
import "../styles/global.css";

export const prerender = false;

// Auto-discover all templates from src/templates/**/
const templateModules = import.meta.glob('../templates/**/*.astro', { eager: true });

// Build registry: "example" â†’ Component (filename only, folder is just organization)
const registry: Record<string, any> = {};
for (const [path, mod] of Object.entries(templateModules)) {
  const filename = path.split('/').pop()!.replace('.astro', '');
  registry[filename] = (mod as any).default;
}

// Resolve template from URL param
const { template } = Astro.params;
const TemplateComponent = template ? registry[template] : undefined;

if (!TemplateComponent) {
  return Astro.redirect('/');
}

// Parse query params
const url = new URL(Astro.request.url);
const uuid = url.searchParams.get('uuid');
const paperWidth = url.searchParams.get('paperWidth') ?? '600';
const paperHeight = url.searchParams.get('paperHeight') ?? '1000';
const isTest = url.searchParams.get('test') === 'true';

// Fetch data from DB
let data: any = null;

if (uuid) {
  const runtime = Astro.locals.runtime;
  const db = runtime.env.DB;

  const row = await db.prepare('SELECT json FROM remaining_jsons WHERE uuid = ?').bind(uuid).first();
  if (row) {
    data = JSON.parse(row.json as string);
    if (!isTest) {
      await db.prepare('DELETE FROM remaining_jsons WHERE uuid = ?').bind(uuid).run();
    }
  }
}
---

<div style={`width:${paperWidth}px;height:${paperHeight}px`}>
  <TemplateComponent data={data} />
</div>
